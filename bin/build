#!/usr/bin/env bash
if [ ! -f project/.env ]; then
    echo ".env not found. Try running 'cp .env.dist .env'"
    exit 1
fi

PROJECT_NAME=$(basename "$PWD")

# Sanitize the directory name (replace spaces with underscores or dashes)
SANITIZED_NAME=$(echo "$PROJECT_NAME" | sed 's/ /_/g')

# Export the sanitized directory name as an environment variable
export DOCKER_PROJECT_NAME="$SANITIZED_NAME"

docker compose down && docker compose up -d \
&& docker compose exec -T php su -s /bin/bash application -c 'cd /app && composer install && composer vendor-expose' \
&& docker run --rm -t -v $PWD/project:/usr/src/app -w /usr/src/app node:14 sh -c "yarn install" \
&& docker run --rm -t --user $(id -u):$(id -g) -v $PWD/project:/usr/src/app -w /usr/src/app node:14 sh -c "node_modules/.bin/gulp" \
&& docker compose exec -T php su -s /bin/bash application -c 'cd /app && ./vendor/bin/sake dev/build "flush=1"'